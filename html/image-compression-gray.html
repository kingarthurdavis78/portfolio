<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVD Image Compression Demo</title>
    <script src="https://unpkg.com/svd-js" type="application/javascript"></script>
</head>
<body>

    <h1>SVD Image Compression Demo</h1>

    <!-- Input Image -->
    <input type="file" id="inputImageFile" accept="image/*">
    <img id="inputImage" style="max-width: 100%; margin-top: 10px;" alt="Input Image">

    <!-- Compressed Image -->
    <h2>Compressed Image</h2>
    <canvas id="canvas" style="max-width: 100%; border: 1px solid #ccc;"></canvas>
    <canvas id="compressedCanvas" style="max-width: 100%; border: 1px solid #ccc;"></canvas>


    <script>
     function matrix_multiplication(A, B) {
      let result = [];
      for (let i = 0; i < A.length; i++) {
            result[i] = [];
            for (let j = 0; j < B[0].length; j++) {
             let sum = 0;
             for (let k = 0; k < A[0].length; k++) {
                 sum += A[i][k] * B[k][j];
              }
              result[i][j] = sum;
            }
         }
         return result;
     }

     function transpose(A) {
         let result = [];
         for (let i = 0; i < A[0].length; i++) {
             result[i] = [];
             for (let j = 0; j < A.length; j++) {
                 result[i][j] = A[j][i];
             }
         }
         return result;
     }

     function diagonalize_vector(v) {
         let result = [];
         for (let i = 0; i < v.length; i++) {
             result[i] = [];
             for (let j = 0; j < v.length; j++) {
                 result[i][j] = 0;
             }
             result[i][i] = v[i];
         }
         return result;
     }

     function reorder(u, v, q) {
         // make q in descending order and reorder u and v accordingly
         u = transpose(u)
         v = transpose(v)
         let q2 = [];
         let u2 = [];
         let v2 = [];
         while (q.length > 0) {
             // find max
             let max = q[0];
             let maxIndex = 0;
             for (let i = 1; i < q.length; i++) {
                 if (q[i] > max) {
                     max = q[i];
                     maxIndex = i;
                 }
             }
             // add max to q2
             q2.push(max);
             // remove max from q
             q.splice(maxIndex, 1);
             // add corresponding column of u to u2
             u2.push(u[maxIndex]);
             u.splice(maxIndex, 1);
             // add corresponding column of v to v2
             v2.push(v[maxIndex]);
             v.splice(maxIndex, 1);
         }


         return [transpose(u2), transpose(v2), q2];
     }

     function average(r, g, b) {
         return (r + g + b) / 3;
     }

     canvas = document.getElementById("canvas");
     ctx = canvas.getContext("2d");
     // load image
     const image = new Image();
     image.src = "assets/imgs/avatar.jpg";
     image.onload = function() {
         // draw image on canvas
         canvas.width = image.width;
         canvas.height = image.height;
         ctx.drawImage(image, 0, 0);
         // get image data
         const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
         const data = imageData.data;
        // convert to grayscale matrix
        let grayscale = [];
        for (let i = 0; i < data.length; i += 4) {
            grayscale.push(average(data[i], data[i + 1], data[i + 2]));
        }
        // replace image data with grayscale
        for (let i = 0; i < data.length; i += 4) {
            data[i] = grayscale[i / 4];
            data[i + 1] = grayscale[i / 4];
            data[i + 2] = grayscale[i / 4];
        }
        // put image data back
        ctx.putImageData(imageData, 0, 0);

        // convert to matrix
        let matrix = [];
        for (let i = 0; i < canvas.height; i++) {
            matrix[i] = [];
            for (let j = 0; j < canvas.width; j++) {
                matrix[i][j] = grayscale[i * canvas.width + j] / 255;
            }
        }
        if (matrix.length < matrix[0].length) {
            // transpose matrix
            matrix = transpose(matrix);
        }


         // apply SVD
        const svd = SVDJS.SVD(matrix);
        console.log(svd);
        [u, v, q] = reorder(svd.u, svd.v, svd.q);
        // get k
         console.log("Singular values: " + q.length);
        let k = 100;
        console.log("k: " + k);
        // get u_k
        let u_k = u.slice(0, u.length).map(row => row.slice(0, k));
        // get q_k
        let q_k = q.slice(0, k);
        // get v_k
        let v_k = v.slice(0, v.length).map(row => row.slice(0, k));
        // get A_k
        let A_k = matrix_multiplication(matrix_multiplication(u_k, diagonalize_vector(q_k)), transpose(v_k));

        // convert to 0-255
        for (let i = 0; i < A_k.length; i++) {
            for (let j = 0; j < A_k[0].length; j++) {
                A_k[i][j] = Math.round(A_k[i][j] * 255);
            }
        }
        // convert to 1D array
        let A_k_1d = [];
        for (let i = 0; i < A_k.length; i++) {
            for (let j = 0; j < A_k[0].length; j++) {
                A_k_1d.push(A_k[i][j]);
                A_k_1d.push(A_k[i][j]);
                A_k_1d.push(A_k[i][j]);
                A_k_1d.push(255);
            }
        }

        console.log(A_k_1d.length);
        // convert to Uint8ClampedArray
        let A_k_1d_u8 = new Uint8ClampedArray(A_k_1d);
        // convert to ImageData
        let imageData_k = new ImageData(A_k_1d_u8, canvas.width, canvas.height);
        // draw image on canvas
        compressedCanvas = document.getElementById("compressedCanvas");
        compressedCtx = compressedCanvas.getContext("2d");
        compressedCanvas.width = canvas.width;
        compressedCanvas.height = canvas.height;
        compressedCtx.putImageData(imageData_k, 0, 0);



     }


    </script>

</body>
</html>
